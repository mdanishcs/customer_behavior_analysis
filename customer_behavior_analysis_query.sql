-- Business Questions


--Q1. What is the total revenue generated by male vs. female customers?
select gender, sum(purchase_amount) as revenue from customer group by gender;
--  Female 75191
--  Male  157890

--Q2. Which customers used a discount but still spent more than the average purchase amount? 
select customer_id, purchase_amount from customer 
where discount_applied = 'Yes' 
and purchase_amount > (select avg(purchase_amount) from customer);

-- Q3. Which are the top 5 products with the highest average review rating?
select item_purchased, round(avg(review_rating::numeric), 2) as "Average Product Rating" from customer
group by item_purchased
order by avg(review_rating) desc limit 5;

--Q4. Compare the average Purchase Amounts between Standard and Express Shipping. 
select shipping_type, round(avg(purchase_amount),2) from customer 
where shipping_type in ('Express', 'Standard')
group by shipping_type;


--Q5. Do subscribed customers spend more? Compare average spend and total revenue 
--between subscribers and non-subscribers.
select subscription_status, 
count(customer_id) as "Total Customer", 
round(avg(purchase_amount),2) as "average_spent" ,
sum(purchase_amount) as "total_revenue" 
from customer group by subscription_status
order by average_spent,total_revenue desc; 

--Q6. Which 5 products have the highest percentage of purchases with discounts applied?
select item_purchased, round(sum(case when discount_applied = 'Yes' then 1 else 0 end)/co) from 
customer group by item_purchased;

--Q7. Segment customers into New, Returning, and Loyal based on their total 
-- number of previous purchases, and show the count of each segment. 
select 
case 
	when previous_purchases = 1 then 'New'
	when previous_purchases between 2 and 10 then 'Returning'
	else 'Loyal' end as cust_segment, count(*) as total_customer
from customer group by cust_segment;

with customer_type as(
	select customer_id, previous_purchases,
	case
		when previous_purchases = 1 then 'New'
		when previous_purchases between 2 and 10 then 'Returning'
		else 'Loyal' end as cust_segment
	from customer
)

select cust_segment, count(*) from customer_type group by cust_segment;


--Q8. What are the top 3 most purchased products within each category? 
with item_count as(
	select category, item_purchased,
	count(customer_id) as total_orders,
	row_number() over(partition by category order by count(customer_id) desc) as item_rank
	from customer group by category, item_purchased
)
select item_rank, category, item_purchased, total_orders from item_count where item_rank <= 3;
 
--Q9. Are customers who are repeat buyers (more than 5 previous purchases)
-- also likely to subscribe?
select subscription_status, count(customer_id) as repeat_buyers from customer
where previous_purchases > 5 group by subscription_status;

--Q10. What is the revenue contribution of each age group?

with revenue_age as(
select purchase_amount, age,
case when age between 18 and 30 then 'Young'
when age between 31 and 43 then 'Adult'
when age between 44 and 57 then 'Mid Age'
else 'Senior' 
end as age_group
from customer
)
select age_group, sum(purchase_amount) as revenue from revenue_age
group by age_group order by revenue desc;
